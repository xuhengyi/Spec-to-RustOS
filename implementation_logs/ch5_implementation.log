# ch5 å®ç°æ—¥å¿—

## å®ç°å¼€å§‹æ—¶é—´
2025-02-05

## ä½¿ç”¨çš„èµ„æº

1. **âœ… å½“å‰ crate çš„ spec**
   - `openspec/specs/ch5/spec.md`ï¼šbootã€kernel åœ°å€ç©ºé—´ã€ELF åŠ è½½ã€portal æ˜ å°„ã€è¿›ç¨‹ç®¡ç†ï¼ˆPManagerï¼‰ã€initproc åŠ è½½ã€è°ƒåº¦å¾ªç¯ã€trap å¤„ç†ã€syscall åˆ†å‘ã€fork/exec/wait/getpid ç­‰
   - `openspec/specs/ch5/design.md`ï¼šå•å…¨å±€ PROCESSORã€Sv39 åœ°å€ç©ºé—´ã€portal æ˜ å°„æ¨¡å‹ã€syscall é›†æˆ

2. **âš ï¸ ç›´æ¥ä¾èµ–çš„ spec**
   - æœªå•ç‹¬é˜…è¯»å…¶ä»– crate çš„ specï¼Œé€šè¿‡é˜…è¯» ch4ã€linkerã€kernel-contextã€kernel-vmã€syscallã€task-manage çš„æºç ç¡®è®¤ API

3. **ğŸ”§ éœ€è¦éªŒè¯çš„ crate ä»£ç ï¼ˆé›†æˆæµ‹è¯•é˜¶æ®µä¿®æ”¹ï¼‰**
   - æ— ï¼šæœ¬æ¬¡å®ç°æœªä¿®æ”¹ task-manage ç­‰ä¾èµ– crate

4. **âŒ å·²ç”Ÿæˆçš„ä»£ç **
   - å‚è€ƒäº† ch4 çš„ main.rs å®ç°ï¼ˆload_elfã€kernel_spaceã€portal è®¾ç½®ã€trap å¤„ç†æµç¨‹ï¼‰

## å®ç°è¿‡ç¨‹

1. **build.rs**
   - ä¸ ch4 ä¸€è‡´ï¼šå°† `linker::SCRIPT` å†™å…¥ `$OUT_DIR/linker.ld`ï¼Œä¼ é€’ `-T$OUT_DIR/linker.ld`ï¼Œ`rerun-if-changed` build.rs / LOG / APP_ASM

2. **main.rs ä¸»æµç¨‹**
   - boot/heap/kernel åœ°å€ç©ºé—´ï¼šä¸ ch4 ç›¸åŒ
   - åº”ç”¨æ³¨å†Œè¡¨ï¼šåŸºäº `AppMeta::locate()` å’Œ `app_names` ç¬¦å·ï¼Œå®ç° `get_app_by_name()`ã€`app_name_at()`ã€`list_app_names()`
   - ä»…åŠ è½½ initprocï¼šä»æ³¨å†Œè¡¨æŒ‰åç§°è·å– "initproc"ï¼Œè°ƒç”¨ `load_elf` åˆ›å»º Process
   - ProcManagerï¼šå®ç° `Manage<Process, ProcId>` + `Schedule<ProcId>`ï¼Œä½¿ç”¨ BTreeMap å­˜å‚¨ã€VecDeque å°±ç»ªé˜Ÿåˆ—
   - PManagerï¼šä½¿ç”¨ `rcore_task_manage::PManager`ï¼Œ`set_manager(ProcManager)`ï¼Œ`add(init_pid, initproc, init_pid)`
   - è°ƒåº¦å¾ªç¯ï¼š`find_next()` å–è¿›ç¨‹ï¼Œæ‰‹åŠ¨è®¾ç½® portal cacheï¼ˆä¸ ch4 ç›¸åŒæ–¹å¼ï¼‰ï¼Œè°ƒç”¨ `LocalContext::execute()`ï¼Œtrap åæ ¹æ® scause åˆ†æ”¯å¤„ç†
   - æ— å°±ç»ªè¿›ç¨‹æ—¶ï¼šæ‰“å°ä¿¡æ¯å¹¶ `sbi_rt::system_reset(Shutdown, NoReason)`

3. **Process ç»“æ„**
   - `pid: ProcId`ã€`context: ForeignContext`ï¼ˆå« LocalContext + satpï¼‰ã€`space: AddressSpace`ã€`stack_top`
   - ä½¿ç”¨ `ForeignContext` çš„ `context` å­—æ®µé…åˆæ‰‹åŠ¨ portal è®¾ç½®æ‰§è¡Œï¼ˆæœªä½¿ç”¨ `ForeignContext::execute()`ï¼Œå› å…¶ä¸ ch4 æ‰‹åŠ¨æ–¹å¼è¡Œä¸ºä¸ä¸€è‡´å¯¼è‡´ InstructionPageFaultï¼‰

4. **SyscallContext å®ç°**
   - IOï¼šwrite(STDOUT/STDDEBUG) é€šè¿‡ CURRENT_SPACE çš„ translate æ‰“å°
   - Processï¼šexit â†’ make_current_exitedï¼›fork â†’ å…‹éš†åœ°å€ç©ºé—´ã€å¤åˆ¶ contextã€å­è¿›ç¨‹ a0=0ã€add åˆ° processorï¼›exec â†’ æŒ‰åç§°åŠ è½½ ELFã€æ›¿æ¢å½“å‰è¿›ç¨‹çš„ context/spaceï¼›waitpid â†’ å¤„ç† pid=-1ï¼ˆwait anyï¼‰å’Œ exit_code_ptr ä¸º nullï¼ˆwait() å•å‚æ•°ï¼‰çš„æƒ…å†µï¼›getpid â†’ è¿”å› CURRENT_PID
   - Schedulingï¼šsched_yield â†’ make_current_suspend
   - Clockï¼šclock_gettime(CLOCK_MONOTONIC) å†™å…¥ TimeSpec

5. **å…³é”®ä¿®å¤**
   - get_app_by_nameï¼šä½¿ç”¨ `apps.nth(i)` æ­£ç¡®è·å–ç¬¬ i ä¸ªåº”ç”¨
   - waitpidï¼šå½“ `exit_code_ptr.is_null()` æ—¶ï¼Œå°† `pid` è§£é‡Šä¸º exit_code_ptrã€pid è®¾ä¸º -1ï¼ˆå…¼å®¹ user lib çš„ wait(ptr) å•å‚æ•°è°ƒç”¨ï¼‰
   - æ‰§è¡Œæ–¹å¼ï¼šé‡‡ç”¨ ch4 é£æ ¼æ‰‹åŠ¨è®¾ç½® portal cache å¹¶è°ƒç”¨ `LocalContext::execute()`ï¼Œé¿å… `ForeignContext::execute()` å¯¼è‡´çš„ InstructionPageFault

## æµ‹è¯•ç»“æœ

- **ç¼–è¯‘**ï¼š`cargo qemu --ch 5` èƒ½å®Œæˆæ„å»º
- **è¿è¡Œ**ï¼šinitproc æˆåŠŸåŠ è½½å¹¶è¿è¡Œï¼Œuser_shell å¯åŠ¨å¹¶æ˜¾ç¤º "Rust user shell" å’Œ ">>"
- **ä¸€æ¬¡ç”Ÿæˆ**ï¼šå¦ï¼Œç»è¿‡å¤šæ¬¡è°ƒè¯•ï¼ˆget_app_by_nameã€waitpid å‚æ•°ã€æ‰§è¡Œæ–¹å¼ï¼‰åé€šè¿‡

## é›†æˆæµ‹è¯•ç»“æœ

- `cargo qemu --ch 5` èƒ½å¯åŠ¨å¹¶è¿›å…¥ user_shell
- **ç®¡é“/expect æµ‹è¯•**ï¼šå·²åˆ›å»º `scripts/test_ch5_shell.sh`ï¼Œä½¿ç”¨ `echo "00hello_world" | cargo qemu --ch 5` éªŒè¯ï¼š
  - ç®¡é“è¾“å…¥èƒ½æˆåŠŸé€è¾¾ user_shell
  - Shell æç¤ºç¬¦ ">>" æ­£å¸¸æ˜¾ç¤º
- **å·²çŸ¥é—®é¢˜**ï¼šä» user_shell æ‰§è¡Œ `00hello_world` æ—¶å‡ºç° "memory allocation of 4096 bytes failed"
  - ç›´æ¥åŠ è½½ 00hello_world ä½œä¸ºé¦–ä¸ªè¿›ç¨‹å¯æ­£å¸¸è¿è¡Œå¹¶è¾“å‡º "Hello, world!"
  - é—®é¢˜ä»…å‡ºç°åœ¨ fork+exec è·¯å¾„ï¼ˆuser_shell å­è¿›ç¨‹ exec æ—¶ï¼‰ï¼Œå¯èƒ½ä¸ exec åç”¨æˆ·å †åˆå§‹åŒ–æˆ–å†…æ ¸å †çŠ¶æ€æœ‰å…³ï¼Œå¾…è¿›ä¸€æ­¥è°ƒè¯•

## å®ç°å®Œæˆæ—¶é—´
2025-02-05

## æ—¥å¿—è¯­è¨€
ä¸­æ–‡
