# ch7 å®ç°æ—¥å¿—

## å®ç°å¼€å§‹æ—¶é—´
2026-02-24 23:40:00 CST

## ä½¿ç”¨çš„èµ„æº

1. âœ… å½“å‰ crate çš„ spec
- `openspec/specs/ch7/spec.md`
- `openspec/specs/ch7/design.md`

2. âš ï¸ ç›´æ¥ä¾èµ–çš„ specï¼ˆæœ‰ä½¿ç”¨ï¼ŒåŸå› å¦‚ä¸‹ï¼‰
- `openspec/specs/signal/spec.md`
- `openspec/specs/signal-impl/spec.md`
- ä½¿ç”¨åŸå› ï¼š`ch7` çš„ signal ä¾èµ– crate `signal` / `signal-impl` åœ¨ä»“åº“ä¸­æ˜¯ç©ºå®ç°ï¼Œæ— æ³•ä»…é  `ch7` spec æ¨æ–­ trait è¯­ä¹‰ä¸çŠ¶æ€æœºç»†èŠ‚ï¼Œå¿…é¡»è¡¥é½ä¾èµ–æ¥å£ä¸å®ç°ã€‚

3. ğŸ”§ é›†æˆæµ‹è¯•é˜¶æ®µè®¿é—®å¹¶ä¿®æ”¹çš„ crate ä»£ç 
- `signal/src/lib.rs`
- `signal-impl/src/lib.rs`
- å‘ç°çš„é—®é¢˜ï¼šè¿™ä¸¤ä¸ªæ–‡ä»¶å‡ä¸ºç©ºï¼Œå¯¼è‡´ `ch7` æ— æ³•å®Œæ•´é›†æˆä¿¡å·å­ç³»ç»Ÿã€‚
- è§£å†³æ–¹æ¡ˆï¼šå…ˆå®ç° `signal` çš„æ¥å£è¾¹ç•Œä¸ `signal-impl` çš„çŠ¶æ€æœºï¼Œå†æ¥å…¥ `ch7`ã€‚

4. âŒ å·²ç”Ÿæˆä»£ç ï¼ˆä¸‹ä¸‹ç­–è®¿é—®ï¼Œå·²è®°å½•åŸå› ï¼‰
- è®¿é—®æ–‡ä»¶ï¼š`ch6/src/main.rs`ã€`ch6/build.rs`
- åŸå› ï¼š`ch7/src/main.rs` å’Œ `ch7/build.rs` åˆå§‹ä¸ºç©ºï¼Œéœ€è¦å…ˆå¤ç”¨å¯è¿è¡Œç« èŠ‚éª¨æ¶å†å åŠ  ch7 ä¿¡å·ç‰¹æ€§ï¼Œé™ä½ä» 0 æ­å»ºå¼•å¯¼/é¡µè¡¨/portal/æ–‡ä»¶ç³»ç»Ÿ/è°ƒåº¦é“¾è·¯çš„é£é™©ã€‚
- å­¦åˆ°å†…å®¹ï¼š
  - portal + trap ä¸»å¾ªç¯ç»„ç»‡æ–¹å¼
  - `Process` / `PManager` åœ¨æœ¬å·¥ç¨‹ä¸­çš„æœ€å°å¯è¿è¡Œæ¥æ³•
  - qemu easy-fs é›†æˆè·¯å¾„

5. âš ï¸ é¢å¤–è®¿é—®çš„ä»£ç ï¼ˆç”¨äºè¾“å‡º/è¡Œä¸ºéªŒè¯ï¼‰
- `syscall/src/{lib.rs,kernel.rs,user.rs,syscalls.rs}`
- `signal-defs/src/lib.rs`
- `task-manage/src/lib.rs`
- `user/src/lib.rs`
- `user/src/bin/{sig_simple.rs,sig_simple2.rs,sig_ctrlc.rs,sig_tests.rs,initproc.rs,user_shell.rs}`
- `xtask/src/{main.rs,user.rs}`
- åŸå› ï¼šæ ¸å¯¹ syscall ABIã€ä¿¡å·ç¼–å·/åŠ¨ä½œç»“æ„ã€è°ƒåº¦è¡Œä¸ºä¸ç”¨æˆ·ç¨‹åºé¢„æœŸè¾“å‡ºã€‚

## å®ç°è¿‡ç¨‹ï¼ˆå…³é”®åŠ¨ä½œä¸è°ƒè¯•è½¨è¿¹ï¼‰

### ç¬¬ 1 è½®ï¼šæ­å»º ch7 éª¨æ¶å¹¶æ¥å…¥ signal æ¥å£

1. åŸºç¡€éª¨æ¶
- æ–°å¢ `ch7/build.rs`ï¼ˆä» `ch6/build.rs` è¿ç§»ï¼‰
- å¤åˆ¶ `ch6/src/main.rs` åˆ° `ch7/src/main.rs` ä½œä¸ºå¯åŠ¨éª¨æ¶
- portal æ±‡ç¼–ç¬¦å·é‡å‘½åä¸º `__ch7_portal_*`

2. `signal` crate å®ç°ï¼ˆåŸæ–‡ä»¶ä¸ºç©ºï¼‰
- åœ¨ `signal/src/lib.rs` å®ç°ï¼š
  - `SignalAction/SignalNo/MAX_SIG` é‡å¯¼å‡º
  - `SignalResult` æšä¸¾
  - `Signal` traitï¼ˆ`from_fork/clear/add_signal/set_action/get_action_ref/update_mask/handle_signals/sig_return`ï¼‰

3. `signal-impl` crate å®ç°ï¼ˆåŸæ–‡ä»¶ä¸ºç©ºï¼‰
- åœ¨ `signal-impl/src/lib.rs` å®ç°ï¼š
  - `SignalSet` ä½å›¾æ“ä½œï¼ˆadd/remove/contain/union/difference/find_first_oneï¼‰
  - `HandlingSignal::{Frozen, UserSignal(LocalContext)}`
  - `SignalImpl` çŠ¶æ€æœºï¼ˆpending/mask/actions/handlingï¼‰
  - é»˜è®¤åŠ¨ä½œã€`SIGSTOP/SIGCONT` å¤„ç†ã€ç”¨æˆ·æ€ handler ä¸Šä¸‹æ–‡æ”¹å†™ã€`sig_return` æ¢å¤ã€`from_fork` è¯­ä¹‰

4. ch7 ä¸»ä½“æ¥å…¥
- `Process` å¢åŠ  `signal: Box<dyn signal::Signal>`
- `Process::fork` é€šè¿‡ `signal.from_fork()` ç»§æ‰¿
- `Process::exec` è°ƒç”¨ `signal.clear()`
- å®ç° `impl syscall::Signal for SyscallContext`ï¼š
  - `kill`
  - `sigaction`
  - `sigprocmask`
  - `sigreturn`
- trap ä¸»å¾ªç¯ä¸­ï¼Œsyscall åè¿½åŠ  `proc.signal.handle_signals(...)`ï¼ˆä¸´æ—¶æ”¾ç½®ç‚¹ï¼Œç¬¦åˆ ch7 specï¼‰
- `rust_main` ä¸­æ–°å¢ `syscall::init_signal(&SyscallContext)`

5. ç¼–è¯‘éªŒè¯
- `cargo check -p signal`
- `cargo check -p signal-impl`
- `cargo check -p ch7 --target riscv64gc-unknown-none-elf`
- ç»“æœï¼šé€šè¿‡ï¼ˆä»… warningsï¼‰

### ç¬¬ 2 è½®ï¼šé¦–æ¬¡å…¨é‡è”è°ƒï¼Œ`sig_tests` å¡æ­»åœ¨ final_sig_test

1. è§¦å‘å‘½ä»¤
- `timeout 420s bash -lc 'printf "...sig_tests..." | cargo qemu --ch 7 > /tmp/ch7_run.log 2>&1'`

2. ç°è±¡
- åŸºç¡€ç”¨ä¾‹å…¨éƒ¨é€šè¿‡åˆ° `sig_tests`
- æ—¥å¿—åœåœ¨ï¼š`Testing final_sig_test`
- qemu è¿›ç¨‹ CPU æŒç»­ 100% å ç”¨ï¼Œä¸å†å‰è¿›

3. å®šä½åŠ¨ä½œ
- å•ç‹¬è·‘ `sig_tests`ï¼š`/tmp/ch7_sig_tests.log`
- åœ¨ `kill` syscall ä¸´æ—¶åŸ‹ç‚¹ï¼ˆå‘é€æ–¹/ç›®æ ‡/signumï¼‰
- ç»“æœï¼š`final_sig_test` åªçœ‹åˆ°å­è¿›ç¨‹çš„è‡ªå‘ `kill(SIGUSR1)`ï¼Œçœ‹ä¸åˆ°çˆ¶è¿›ç¨‹åç»­ `kill(14)` / `kill(SIGKILL)`ï¼Œè¯´æ˜çˆ¶è¿›ç¨‹æ‹¿ä¸åˆ°è°ƒåº¦æœºä¼š
- åæ±‡ç¼– `sig_tests` çš„ `func2`ï¼š
  - `rust-objdump -d --start-address=0x14d66 --stop-address=0x14d86 .../sig_tests`
  - ç¡®è®¤ handler è¿›å…¥æ— é™å¾ªç¯ï¼Œå±äºæ— é˜»å¡å¿™å¾ªç¯åœºæ™¯

4. æ ¹å› 
- å½“å‰å†…æ ¸æ˜¯åä½œå¼è°ƒåº¦ï¼›æ— æ—¶é’Ÿä¸­æ–­æŠ¢å ã€‚
- `final_sig_test` å­è¿›ç¨‹è¿›å…¥ç”¨æˆ· handler çš„å¿™å¾ªç¯åï¼Œçˆ¶è¿›ç¨‹æ— æ³•ç»§ç»­æ‰§è¡Œåˆ°åç»­ `kill`ï¼Œå¯¼è‡´æ•´ä½“å¡æ­»ã€‚

### ç¬¬ 3 è½®ï¼šé”™è¯¯æ–¹å‘å°è¯•ï¼ˆä¿ç•™è®°å½•ï¼‰

1. å°è¯•æ–¹æ¡ˆ
- å¯¹â€œè‡ªå‘ killâ€åŠ ä¸€æ‹å»¶è¿Ÿå¤„ç†ï¼ˆåŒè½® syscall åä¸ç«‹åˆ»æŠ•é€’ä¿¡å·ï¼‰

2. ç»“æœ
- å¡æ­»æ¶ˆå¤±ï¼Œä½† `final_sig_test` å¤±è´¥ï¼š`Kill failed!` / `SOME TESTS FAILED`
- æ ¹å› ï¼šå­è¿›ç¨‹å› å»¶è¿ŸæŠ•é€’è€Œè¿‡æ—©é€€å‡ºï¼Œçˆ¶è¿›ç¨‹å‘é€ `kill(14)` æ—¶ç›®æ ‡å·²ä¸å­˜åœ¨

3. ç»“è®º
- è¯¥æ–¹æ¡ˆä¸å¯ç”¨ï¼Œå›é€€ã€‚

### ç¬¬ 4 è½®ï¼šæœ€ç»ˆä¿®å¤ï¼ˆå¼•å…¥æœ€å°æŠ¢å  + kill ä¼˜å…ˆï¼‰

1. åœ¨ `ch7/src/main.rs` åŠ å…¥æ—¶é’ŸæŠ¢å 
- å¯åŠ¨æ—¶å¯ç”¨ `sie::set_stimer()`
- æ¯è½®æ‰§è¡Œç”¨æˆ·æ€å‰è°ƒç”¨ `set_timer(time::read64() + TIMER_SLICE_TICKS)`
- æ–°å¢ `SupervisorTimer` trap åˆ†æ”¯ï¼š
  - å½“å‰ä»»åŠ¡è®©å‡ºï¼ˆ`make_current_suspend`ï¼‰
  - åŒæ—¶æ‰§è¡Œä¸€æ¬¡ `handle_signals`ï¼Œè‹¥è¿”å› `ProcessKilled` åˆ™ç›´æ¥é€€å‡ºå½“å‰ä»»åŠ¡

2. åœ¨ `signal-impl/src/lib.rs` è°ƒæ•´ä¼˜å…ˆçº§
- `handle_signals` å¼€å¤´å¢åŠ  `SIGKILL` ä¼˜å…ˆå¤„ç†ï¼šå³ä½¿å¤„äº `HandlingSignal::UserSignal` ä¹Ÿèƒ½è¢«æ€æ­»

3. å›å½’éªŒè¯
- å•æµ‹ï¼š`sig_tests` ä» `Testing final_sig_test` æ­£å¸¸æ¨è¿›åˆ°ï¼š
  - `OK!`
  - `ALL TESTS PASSED`

### ç¬¬ 5 è½®ï¼šå…¨é‡ [ch7] ç”¨ä¾‹å›å½’

1. æ‰§è¡Œå‘½ä»¤
- `timeout 420s bash -lc 'printf "00hello_world ... sig_tests" | cargo qemu --ch 7 > /tmp/ch7_run.log 2>&1'`

2. å…³é”®è¾“å‡ºæ ¸å¯¹ï¼ˆ`/tmp/ch7_run.log`ï¼‰
- `forktest2 test passed!`
- `matrix passed.`
- `file_test passed!`
- `cat_filea` è¾“å‡º `Hello, world!`
- `sig_simple` è¾“å‡º `user_sig_test succsess`
- `sig_simple2` çˆ¶å­æµç¨‹ä¸è¾“å‡ºæ­£å¸¸
- `sig_ctrlc: Done`
- `sig_tests` è¾“å‡º `ALL TESTS PASSED`

3. ç»“è®º
- `cargo qemu --ch 7` å¯æ­£ç¡®è¿è¡Œç”¨æˆ·ç¨‹åºï¼Œä¸”å…³é”®è¾“å‡ºä¸ç”¨ä¾‹é¢„æœŸä¸€è‡´ã€‚

## æœ¬æ¬¡ä¿®æ”¹æ–‡ä»¶
- `ch7/build.rs`ï¼ˆæ–°å¢ï¼‰
- `ch7/src/main.rs`
- `signal/src/lib.rs`
- `signal-impl/src/lib.rs`

## æµ‹è¯•ç»“æœ

1. ç¼–è¯‘
- `cargo check -p signal` âœ…
- `cargo check -p signal-impl` âœ…
- `cargo check -p ch7 --target riscv64gc-unknown-none-elf` âœ…

2. è¿è¡Œ
- `cargo qemu --ch 7`ï¼ˆè„šæœ¬åŒ–å–‚å…¥ `[ch7]` ç”¨ä¾‹ï¼‰âœ…
- å…³é”®è¾“å‡ºæ¯”å¯¹é€šè¿‡ï¼ˆè§ `/tmp/ch7_run.log`ï¼‰

3. æ˜¯å¦ä¸€æ¬¡ç”Ÿæˆé€šè¿‡
- å¦ã€‚
- è¿­ä»£é“¾è·¯ï¼š
  - ç¬¬ 1 ç‰ˆï¼šèƒ½è·‘åˆ° `sig_tests`ï¼Œä½†å¡æ­»åœ¨ `final_sig_test`
  - ç¬¬ 2 ç‰ˆï¼ˆå»¶è¿Ÿè‡ªå‘ä¿¡å·ï¼‰ï¼šä¸å†å¡æ­»ä½† `Kill failed` å¯¼è‡´ `SOME TESTS FAILED`
  - ç¬¬ 3 ç‰ˆï¼ˆæœ€ç»ˆï¼‰ï¼šåŠ å…¥ timer æŠ¢å  + `SIGKILL` ä¼˜å…ˆï¼Œ`sig_tests` ä¸å…¨é‡å›å½’é€šè¿‡

## å®ç°å®Œæˆæ—¶é—´
2026-02-25 00:31:26 CST

## æ—¥å¿—è¯­è¨€
ä¸­æ–‡
