# ch2 å®ç°æ—¥å¿—

## å®ç°å¼€å§‹æ—¶é—´
2026-01-24 çº¦ 11:30 (UTC+8)

## ä½¿ç”¨çš„èµ„æº

### âœ… å½“å‰ crate çš„ spec
- `openspec/specs/ch2/spec.md` - ä¸»è¦å®ç°è§„èŒƒ
- `openspec/specs/ch2/design.md` - è®¾è®¡æ–‡æ¡£

### âš ï¸ ç›´æ¥ä¾èµ–çš„ specï¼ˆå·²ä½¿ç”¨ï¼Œè¯´æ˜åŸå› ï¼‰
1. `openspec/specs/linker/spec.md` - éœ€è¦äº†è§£ `boot0!` å®ã€`KernelLayout`ã€`AppMeta` çš„æ¥å£
2. `openspec/specs/console/spec.md` - éœ€è¦äº†è§£ `Console` trait å’Œåˆå§‹åŒ–å‡½æ•°
3. `openspec/specs/kernel-context/spec.md` - éœ€è¦äº†è§£ `LocalContext` çš„æ¥å£å’Œæ‰§è¡Œè¯­ä¹‰
4. `openspec/specs/syscall/spec.md` - éœ€è¦äº†è§£ syscall handler traits å’Œ `handle` å‡½æ•°

åŸå› ï¼šch2 spec ä»…æè¿°äº†å†…æ ¸çš„è¡Œä¸ºï¼Œä½†å…·ä½“çš„ API è°ƒç”¨æ–¹å¼éœ€è¦å‚è€ƒä¾èµ– crate çš„ specã€‚

### ğŸ”§ éœ€è¦éªŒè¯çš„ crate ä»£ç ï¼ˆå·²è®¿é—®å’Œä¿®æ”¹ï¼‰

#### kernel-context crate
**å‘ç°çš„é—®é¢˜**ï¼š
1. åŸå®ç°ä½¿ç”¨ `#[naked]` å’Œ `asm!` å®ï¼Œåœ¨æ–°ç‰ˆ Rust ä¸­éœ€è¦æ”¹ä¸º `#[unsafe(naked)]` å’Œ `naked_asm!`
2. å¯„å­˜å™¨æ˜ å°„ä¸æ­£ç¡®ï¼šä»£ç ä¸­ x5/x6/x7 çš„åç§»é‡ä¸ç›®æ ‡å¯„å­˜å™¨ä¸åŒ¹é…
3. sstatus è®¾ç½®ä¸æ­£ç¡®ï¼šåº”è¯¥è®¾ç½® SPIE (bit 5) è€Œä¸æ˜¯ SIE (bit 1) æ¥æ§åˆ¶ sret åçš„ä¸­æ–­çŠ¶æ€
4. å†…æ ¸æ ˆæŒ‡é’ˆä¿å­˜/æ¢å¤æœºåˆ¶ä¸å®Œå–„

**ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
- `kernel-context/src/lib.rs`

**ä¿®æ”¹åŸå› å’Œè§£å†³æ–¹æ¡ˆ**ï¼š
å®Œå…¨é‡å†™äº† execute å‡½æ•°å’Œç›¸å…³çš„æ±‡ç¼–ä»£ç ï¼š
1. ä½¿ç”¨ `global_asm!` å®šä¹‰ `__execute_context` å’Œ `__trap_handler` å‡½æ•°
2. æ­£ç¡®ä¿å­˜å†…æ ¸æ ˆæŒ‡é’ˆåˆ° sscratchï¼Œåœ¨ trap handler ä¸­æ¢å¤
3. æ­£ç¡®æ˜ å°„æ‰€æœ‰ RISC-V å¯„å­˜å™¨åˆ° LocalContext ç»“æ„ä½“åç§»
4. ä½¿ç”¨ csrrw æŒ‡ä»¤åŸå­äº¤æ¢ a0 å’Œ sscratch æ¥å®‰å…¨ä¿å­˜/æ¢å¤ä¸Šä¸‹æ–‡

#### linker crate
**å‘ç°çš„é—®é¢˜**ï¼š
`AppIterator::next()` ä¸­åœ°å€æ•°ç»„çš„è¯»å–ä½ç½®ä¸æ­£ç¡®ï¼Œä½¿ç”¨äº† `.add(1)` è·³è¿‡äº† `first` å­—æ®µï¼Œä½† `first` å­—æ®µæœ¬èº«å°±æ˜¯åœ°å€æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚

**ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
- `linker/src/lib.rs`

**ä¿®æ”¹åŸå› å’Œè§£å†³æ–¹æ¡ˆ**ï¼š
ç§»é™¤äº† `.add(1)` è°ƒç”¨ï¼Œç›´æ¥ä» `first` å­—æ®µå¼€å§‹è¯»å–åœ°å€æ•°ç»„ã€‚

#### user crate
**å‘ç°çš„é—®é¢˜**ï¼š
ç”¨æˆ·ç¨‹åºæ²¡æœ‰ `build.rs` æ¥å¤„ç† `BASE_ADDRESS` ç¯å¢ƒå˜é‡å¹¶ç”Ÿæˆæ­£ç¡®çš„é“¾æ¥è„šæœ¬ï¼Œå¯¼è‡´ç”¨æˆ·ç¨‹åºæ²¡æœ‰è¢«æ­£ç¡®é“¾æ¥åˆ°æŒ‡å®šçš„åŸºåœ°å€ï¼ˆ0x80400000ï¼‰ã€‚

**ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
- `user/build.rs`ï¼ˆæ–°åˆ›å»ºï¼‰

**ä¿®æ”¹åŸå› å’Œè§£å†³æ–¹æ¡ˆ**ï¼š
åˆ›å»º build.rs æ¥ï¼š
1. è¯»å– `BASE_ADDRESS` ç¯å¢ƒå˜é‡ï¼ˆé»˜è®¤ 0x80400000ï¼‰
2. ç”ŸæˆåŒ…å«æ­£ç¡®å…¥å£ç‚¹å’Œæ®µå¸ƒå±€çš„é“¾æ¥è„šæœ¬
3. ç¡®ä¿ `.text.entry` æ®µåœ¨æœ€å‰é¢

### âŒ å·²ç”Ÿæˆçš„ä»£ç ï¼ˆæœªä½¿ç”¨ï¼‰
æœªè®¿é—®ä»»ä½•å·²ç”Ÿæˆçš„ä»£ç ã€‚

## å®ç°è¿‡ç¨‹

### 1. åˆå§‹å®ç°
åˆ›å»ºäº† `ch2/build.rs` å’Œ `ch2/src/main.rs`ï¼š
- build.rsï¼šç”Ÿæˆ linker.ld å¹¶ä¼ é€’é“¾æ¥å‚æ•°
- main.rsï¼šå®ç°æ‰¹å¤„ç†å†…æ ¸çš„æ ¸å¿ƒé€»è¾‘

### 2. ç¬¬ä¸€æ¬¡ç¼–è¯‘é”™è¯¯
kernel-context crate ç¼–è¯‘å¤±è´¥ï¼š
- `#[naked]` éœ€è¦ `#[unsafe(naked)]`
- `asm!` åœ¨ naked å‡½æ•°ä¸­éœ€è¦æ”¹ä¸º `naked_asm!`
- å‚æ•°ä¸èƒ½ä½¿ç”¨ `in(reg)` æ“ä½œæ•°

ä¿®å¤ï¼šé‡å†™ naked å‡½æ•°ä½¿ç”¨æ­£ç¡®çš„è¯­æ³•ã€‚

### 3. ç¬¬äºŒæ¬¡ç¼–è¯‘é”™è¯¯
ch2 ç¼–è¯‘å¤±è´¥ï¼š
- `#![feature(naked_functions)]` ä¸å†éœ€è¦
- `syscall::IO` å’Œ `syscall::Process` trait çš„æ–¹æ³•ç­¾åä¸åŒ¹é…
- ç¼ºå°‘ä¸€äº› trait æ–¹æ³•çš„å®ç°

ä¿®å¤ï¼šæ›´æ–°æ–¹æ³•ç­¾åï¼Œæ·»åŠ ç¼ºå¤±çš„æ–¹æ³•å®ç°ã€‚

### 4. è¿è¡Œæ—¶é—®é¢˜ - ç¨‹åºå¡ä½
ç¨‹åºå¯åŠ¨åå¡åœ¨ "Running app 0"ï¼Œæ²¡æœ‰ä»»ä½•è¾“å‡ºã€‚

è°ƒè¯•è¿‡ç¨‹ï¼š
1. æ£€æŸ¥ sstatus è®¾ç½® - å‘ç°åº”è¯¥è®¾ç½® SPIE è€Œä¸æ˜¯ SIE
2. æ£€æŸ¥å¯„å­˜å™¨æ˜ å°„ - å‘ç°åç§»é‡å’Œç›®æ ‡å¯„å­˜å™¨ä¸åŒ¹é…
3. å®Œå…¨é‡å†™ kernel-context çš„æ‰§è¡Œé€»è¾‘

### 5. è¿è¡Œæ—¶é—®é¢˜ - IllegalInstruction
ç¨‹åºè¿è¡Œä½†æ‰€æœ‰åº”ç”¨éƒ½æŠ¥ IllegalInstruction æˆ– LoadFaultã€‚

è°ƒè¯•è¿‡ç¨‹ï¼š
1. æ£€æŸ¥ç”¨æˆ·ç¨‹åºäºŒè¿›åˆ¶æ–‡ä»¶ - å‘ç°å¼€å¤´æ˜¯æ•°æ®è€Œä¸æ˜¯ä»£ç 
2. åˆ›å»º `user/build.rs` ç”Ÿæˆæ­£ç¡®çš„é“¾æ¥è„šæœ¬
3. é‡æ–°æ„å»ºåä»ç„¶æŠ¥é”™

### 6. å‘ç° linker crate bug
æ£€æŸ¥ `linker::AppMeta::iter()` çš„å®ç°ï¼Œå‘ç°åœ°å€æ•°ç»„è¯»å–ä½ç½®é”™è¯¯ã€‚

ä¿®å¤ï¼šç§»é™¤ `.add(1)` è°ƒç”¨ã€‚

### 7. æœ€ç»ˆéªŒè¯
æ‰€æœ‰ 5 ä¸ªæµ‹è¯•ç”¨ä¾‹æ­£ç¡®è¿è¡Œï¼š
- `00hello_world`: è¾“å‡º "Hello, world!" å¹¶æ­£å¸¸é€€å‡º
- `01store_fault`: è§¦å‘ StoreFault è¢«å†…æ ¸æ€æ­»
- `02power`: æ­£ç¡®è®¡ç®—å¹‚æ¬¡å¹¶è¾“å‡ºç»“æœ
- `03priv_inst`: è§¦å‘ IllegalInstruction è¢«å†…æ ¸æ€æ­»
- `04priv_csr`: è§¦å‘ IllegalInstruction è¢«å†…æ ¸æ€æ­»

## æµ‹è¯•ç»“æœ

### Gate éªŒè¯
âœ… `cargo qemu --ch 2` é€šè¿‡

### æ˜¯å¦ä¸€æ¬¡ç”Ÿæˆå°±é€šè¿‡æµ‹è¯•
âŒ å¦

ä»£ç ç»è¿‡å¤šæ¬¡è¿­ä»£ä¿®æ”¹æ‰é€šè¿‡æµ‹è¯•ï¼Œä¸»è¦é—®é¢˜å‡ºåœ¨ï¼š
1. kernel-context crate çš„å®ç°é—®é¢˜ï¼ˆè¯­æ³•ã€å¯„å­˜å™¨æ˜ å°„ã€sstatus è®¾ç½®ï¼‰
2. linker crate çš„å®ç°é—®é¢˜ï¼ˆåœ°å€æ•°ç»„åç§»ï¼‰
3. user crate ç¼ºå°‘ build.rs

## é›†æˆæµ‹è¯•ç»“æœ
âœ… `cargo qemu --ch 2` é€šè¿‡

### æµ‹è¯•è¾“å‡º
```
[ INFO] Hello, rCore-Tutorial ch2!
[ INFO] Starting batch execution...
[ INFO] Running app 0: 36880 bytes
Hello, world!
[ INFO] Application exited with code 0
[ INFO] Running app 1: 36880 bytes
Into Test store_fault, we will insert an invalid store operation...
Kernel should kill this application!
[ERROR] Unexpected trap Exception(StoreFault), sepc = 0x8040018e, stval = 0x0
[ INFO] Running app 2: 40976 bytes
3^10000=5079(MOD 10007)
3^20000=8202(MOD 10007)
...
Test power OK!
[ INFO] Application exited with code 0
[ INFO] Running app 3: 36880 bytes
Try to execute privileged instruction in U Mode
Kernel should kill this application!
[ERROR] Unexpected trap Exception(IllegalInstruction), sepc = 0x804000cc, stval = 0x0
[ INFO] Running app 4: 36880 bytes
Try to access privileged CSR in U Mode
Kernel should kill this application!
[ERROR] Unexpected trap Exception(IllegalInstruction), sepc = 0x804000cc, stval = 0x0
[ INFO] All applications finished. Shutting down...
```

## å®ç°å®Œæˆæ—¶é—´
2026-01-24 çº¦ 12:15 (UTC+8)

## ä¿®æ”¹çš„æ–‡ä»¶æ±‡æ€»
1. `ch2/build.rs` - æ–°åˆ›å»º
2. `ch2/src/main.rs` - æ–°åˆ›å»º
3. `kernel-context/src/lib.rs` - ä¿®æ”¹ï¼ˆä¿®å¤æ‰§è¡Œé€»è¾‘ï¼‰
4. `linker/src/lib.rs` - ä¿®æ”¹ï¼ˆä¿®å¤åœ°å€æ•°ç»„è¯»å–ï¼‰
5. `user/build.rs` - æ–°åˆ›å»º

## æ—¥å¿—è¯­è¨€
ä¸­æ–‡
